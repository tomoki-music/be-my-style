= render 'layouts/header_menu'
.event-show
  .event-show-title
    %h2 ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°
    .event-show-follow
      = link_to 'å‚åŠ ã™ã‚‹ğŸµ', '#event-songs', data: { 'turbolinks': false }, class: "btn btn-sm btn-info event-show-btn"
      .event-request-icon
        = link_to '#event-request', class: "request-icon-text", data: { 'turbolinks': false } do
          %i.fa-regular.fa-comments.request-icon
          ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹

  .event-show-container.px-0.px-sm-0
    æœ€çµ‚æ›´æ–°æ—¥:
    = l @event.updated_at, format: :short
    (
    = time_ago_in_words(@event.updated_at) + "å‰"
    )
    .row
      .col-md-3
        .event-show-card
          .card
            .img-container
              - if @event.event_image.present?
                = image_tag @event.event_image
              - else
                = image_tag 'no_image'
            .card-body.text-container
              %h5.card-title
                = @event.event_name
              %hr
              %h6.card-subtitle
                [ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆè€…]
                %br
                .event-owner-img
                  = link_to public_customer_path(@owner), data: { 'turbolinks': false } do
                    - if @owner.profile_image.present?
                      = image_tag @owner.profile_image
                    - else
                      = image_tag 'no_image'
                    .owner-name
                      = @owner.name
              %hr
                .got-request-count
                  ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°
                  %i.fa-regular.fa-comments
                  #got-request-count.count
                    = @event.requests.count
              %hr
              %p.card-text
              - if @owner == current_customer
                .mt-2
                  = link_to 'ã‚¤ãƒ™ãƒ³ãƒˆã®ç·¨é›†', edit_public_event_path(@event, community_id: @event.community_id), data: { 'turbolinks': false }, class: "btn btn-sm btn-info event-show-btn"
                  = link_to 'ã‚¤ãƒ™ãƒ³ãƒˆã®å‰Šé™¤', public_event_path(@event), method: :delete, data: { 'turbolinks': false, confirm: 'ã“ã¡ã‚‰ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ' }, class: "btn btn-sm btn-danger event-show-btn"
                  %hr
                  = link_to 'å‚åŠ ã™ã‚‹ğŸµ', '#event-songs', data: { 'turbolinks': false }, class: "btn btn-sm btn-info event-show-btn"
                  = link_to 'ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹ğŸµ', '#event-request', data: { 'turbolinks': false }, class: "btn btn-sm btn-info event-show-btn"
              - else
                = link_to 'å‚åŠ ã™ã‚‹ğŸµ', '#event-songs', data: { 'turbolinks': false }, class: "btn btn-sm btn-info event-show-btn"
                = link_to 'ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹ğŸµ', '#event-request', data: { 'turbolinks': false }, class: "btn btn-sm btn-info event-show-btn"

      .col-md-9
        .table-responsive(style="width: 100%;")
          %table.table.table-striped.event-show-table{:border=>"1", style: "width: 100%;"}
            %colgroup
              %col{width: "19%"}
              %col{width: "81%"}
                %tr
                  %th{scope:"row"} é–‹å‚¬ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£
                  %td
                    = @community.name
                    .text-red
                      â€»ã“ã®ã‚¤ãƒ™ãƒ³ãƒˆã¯ã€#{@community.name}ã€‘ã«å‚åŠ ã—ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
                %tr
                  %th{scope:"row"} ã‚¤ãƒ™ãƒ³ãƒˆå
                  %td
                    = @event.event_name
                - if @event.url.present?
                  %tr
                    %th{scope:"row"} å‚è€ƒURL
                    %td
                      .event-url
                        - text = @event.url
                        = link_to text, @event.url, target: :_blank, rel: "noopener noreferrer", data: { 'turbolinks': false }
                        %hr
                        = @event.url_comment
                %tr
                  %th{scope:"row"} é–‹å§‹æ™‚é–“
                  %td
                    %h4.font-weight-bold
                      <i class="fa-regular fa-clock"></i>
                      = l @event.event_start_time, format: :short
                %tr
                  %th{scope:"row"} çµ‚äº†æ™‚é–“
                  %td
                    %h4.font-weight-bold
                      <i class="fa-regular fa-clock"></i>
                      = l @event.event_end_time, format: :short
                %tr
                  %th{scope:"row"} å‚åŠ è²»ç”¨
                  %td
                    %h5.font-weight-bold
                      <i class="fa-solid fa-sack-dollar"></i>
                      = @event.entrance_fee.to_s(:delimited) + "å††"
                %tr
                  %th{scope:"row"} é–‹å‚¬å ´æ‰€
                  %td
                    %h5.font-weight-bold
                      <i class="fa-solid fa-earth-asia"></i>
                      = @event.place
                %tr
                  %th{scope:"row"} é–‹å‚¬å ´æ‰€ï¼ˆåœ°å›³ï¼‰
                  %td
                    .map-wrapper
                      #map
                %tr
                  %th{scope:"row"} å‚åŠ äººæ•°
                  %td
                    .font-weight-bold
                      <i class="fa-solid fa-people-group"></i>
                      #{@joined_member_counts}äºº
                - if @join_members.present?
                  %tr 
                    %th{scope:"row"} å‚åŠ ãƒ¡ãƒ³ãƒãƒ¼
                    %td
                      .join-member-list
                        - @join_members.each do |customer|
                          = link_to public_customer_path(customer), class: 'image-style', data: { 'turbolinks': false } do
                            - if customer.profile_image.present?
                              = image_tag customer.profile_image, class: "icon_mini"
                            - else
                              = image_tag 'no_image', class: "icon_mini"
                            = customer.name
                          %br
                          %hr
                %tr
                  %th{scope:"row"} æˆç«‹æ¥½æ›²æ•°
                  %td
                    %h4.text-red
                      #{@complete_count}æ›² æˆç«‹!!
                    (å…¨#{@event.songs.length}æ›²)
                - if @event.event_entry_deadline.present?
                  %tr
                    %th{scope:"row"} å‚åŠ ç· åˆ‡æ—¥
                    %td
                      %h5.font-weight-bold
                        = l @event.event_entry_deadline, format: :short
                        ã¾ã§
                %tr
                  %th{scope:"row"} æ¥½æ›²
                  %td{colspan: "100"}
                    = form_tag(public_event_join_confirm_path(@event), method: :get, id: 'join_btn', onSubmit: "return CheckJoin()") do
                      #event-songs.event-songs-join-form
                        %div{ style: "display: flex; justify-content: flex-start; align-items: center; margin-bottom: 12px;" }
                          %div{ style: "display: flex; align-items: center; gap: 12px;" }
                            %button.btn.btn-sm.btn-outline-info#help-popover{
                              type: "button",
                              data: {
                                toggle: "popover",
                                html: "true",
                                content: "â‘ ã”å¸Œæœ›ã®ã€Œå‚åŠ ãƒ‘ãƒ¼ãƒˆã€ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚ï¼ˆè¤‡æ•°ãƒã‚§ãƒƒã‚¯å¯ï¼‰<br><br>â‘¡ã€Œå‚åŠ ç¢ºèªç”»é¢ã¸ã€ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦å†…å®¹ã«é–“é•ã„ãªã‘ã‚Œã°ã€Œå‚åŠ ç¢ºå®šã€ã—ã¦ãã ã•ã„ã€‚<br><br>â‘¢å‚åŠ ãŒç¢ºå®šã™ã‚‹ã¨æ¥½æ›²ä¸€è¦§è¡¨ã«ã”è‡ªèº«ã®ã‚¢ã‚¤ã‚³ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚<br><br>â€»ã”æ³¨æ„â€»<br>â‘¢ã§å‚åŠ ãŒã§ããªã„å ´åˆï¼šäº‹å‰ã«ã€Œé–‹å‚¬ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã€ã¸å‚åŠ ç”³è«‹ã‚’è¡Œã£ã¦ä¸‹ã•ã„ã€‚<br><br>ã€ã”å‚è€ƒã€‘<br>ç¾åœ¨ã®å‚åŠ ãƒ¡ãƒ³ãƒãƒ¼ã¯ä¸€è¦§è¡¨ã‚’å³ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã™ã‚‹ã¨å…¨ä½“åƒãŒç¢ºèªã§ãã¾ã™ğŸµ",
                                placement: "bottom"
                              }
                            }
                              ?
                            %input#submit_join_form{
                              type: "submit",
                              value: "å‚åŠ ç¢ºèªç”»é¢ã¸",
                              class: "btn btn-lg btn-primary",
                              style: "padding: 12px 32px; font-size: 1.2rem; min-width: 220px; white-space: nowrap;",
                              disabled: true,
                              data: {'disable_with': 'é€ä¿¡ä¸­...', 'turbolinks': false}
                            }
                        
                        %div.filter-buttons{ style: "margin-bottom: 12px;" }
                          %button.btn.btn-outline-primary#filter-all(type="button") ã™ã¹ã¦è¡¨ç¤º
                          %button.btn.btn-outline-success#filter-complete(type="button") æ¥½æ›²æˆç«‹
                          %button.btn.btn-outline-warning#filter-vacant(type="button") å‹Ÿé›†ä¸­

                        %div.responsive-wrapper{ style: "position: relative;" }
                          %div.scroll-indicator{id: "scroll-indicator"} â†’
                          %div.responsive-box
                            - part_names = ["Vocal", "Guitar", "Bass", "Drums", "Keyboard", "Other"] 
                            %table.table.table-bordered.event-songs-table{ style: "min-width: 930px; table-layout: fixed;" }
                              %thead
                                %tr
                                  %th{ style: "width: 160px;" } æ›²å / ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
                                  %th{ style: "width: 160px;" } å‚åŠ ãƒ•ã‚©ãƒ¼ãƒ 
                                  - part_names.each do |part|
                                    %th{ style: "min-width: 90px;" }= part
                              %tbody
                                - @event.songs.each do |song|
                                  - vacant = song.join_parts.any? { |jp| jp.customers.count == 0 }
                                  %tr{ class: (vacant ? 'vacant' : 'complete') }
                                    %td{ style: "max-width: 120px; overflow-wrap: break-word; word-break: break-word; white-space: normal;" }
                                      - if vacant
                                        %span.badge.badge-warning å‹Ÿé›†ä¸­!!
                                      - else
                                        %span.badge.badge-success æ¥½æ›²æˆç«‹ğŸµ
                                      %br
                                      %div{ style: "white-space: normal; word-break: break-word;" }
                                        = link_to song.song_name, public_event_song_path(@event, song), class: "song-detail-link", data: { turbolinks: false }

                                    %td
                                      .check-part-list
                                        - if @event.event_end_time > Time.now
                                          - song.join_parts.each do |part|
                                            .check-part-item(style="margin-bottom: 4px;")
                                              = label_tag "event_join_part_ids_#{part.id}" do
                                                = check_box_tag "event[join_part_ids][]", part.id, false, id: "event_join_part_ids_#{part.id}"
                                                = part.join_part_name
                                              = hidden_field_tag :event_id, @event.id
                                        - else
                                          çµ‚äº†ã‚¤ãƒ™ãƒ³ãƒˆã®ãŸã‚ãƒã‚§ãƒƒã‚¯ä¸å¯

                                    - part_names.each do |part_name|
                                      - join_part = song.join_parts.find { |jp| jp.join_part_name == part_name }
                                      %td
                                        - if join_part.present?
                                          - if join_part.customers.any?
                                            - join_part.customers.each do |customer|
                                              .member-display(style="display:flex; flex-direction:column; align-items:flex-start; gap:4px; margin-bottom:4px;")
                                                = link_to public_customer_path(customer), data: { turbolinks: false } do
                                                  = image_tag(customer.profile_image.presence || 'no_image',
                                                              class: "icon_mini",
                                                              style: "width:24px; height:24px; border-radius:50%;")
                                                  = customer.name
                                                - if customer == current_customer && join_part.customers.include?(current_customer) && @event.event_start_time > Time.current + 7.days
                                                  = link_to "å‰Šé™¤",
                                                    public_event_delete_path(@event, join_part_id: join_part.id, customer_id: customer.id),
                                                    method: :delete,
                                                    data: { confirm: "ã“ã®å‚åŠ ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ" },
                                                    class: "btn btn-danger w-100"
                                          - else
                                            %span.text-danger å‹Ÿé›†ä¸­
                                        - else
                                          ãƒ¼
                %tr
                  %th{scope:"row"} ã‚¤ãƒ™ãƒ³ãƒˆè£œè¶³
                  %td
                    = simple_format(@event.introduction)
                - if @owner == current_customer
                  %tr
                    %th{scope:"row"} CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                    %td
                      = link_to "å‚åŠ ä¸€è¦§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰", public_event_path(@event, format: :csv), data: { 'turbolinks': false }, class: "btn btn-sm btn-info event-show-btn"
        #event-request.event-request
          - if @event.request_deadline.present?
            .event-request-deadline
              æ›²ãƒªã‚¯ã‚¨ã‚¹ãƒˆç· åˆ‡æ—¥:
              %h5
                = l @event.request_deadline, format: :short
                ã¾ã§
          = render 'public/requests/form', event: @event, request: @request
          #event-request-asy.request-part
            = render 'public/requests/requests', event: @event

  %div{type: "text/javascript"}
    :javascript
      function CheckJoin(){
        if(confirm("å‚åŠ ç”³è«‹ã—ã¾ã™ã‹ï¼Ÿ")){
          return true; 
        }else{
          alert('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ'); 
          location.reload();
          return false; 
        }
      }

  - latitude = @latitude
  - longitude = @longitude
  - address = @address

  %div{type: "text/javascript"}
    :javascript
      function initMap() {
        var test = {lat: #{latitude}, lng: #{longitude}};
        var map = new google.maps.Map(document.getElementById('map'), {
                  zoom: 15, 
                  center: test
                  });
        var transitLayer = new google.maps.TransitLayer();
        transitLayer.setMap(map);

        var contentString = "ä½æ‰€ï¼š #{address}";
        var infowindow = new google.maps.InfoWindow({
          content: contentString
        });

        var marker = new google.maps.Marker({
                      position:test,
                      map: map,
                      title: contentString
                      });

        marker.addListener('click', function() {
          infowindow.open(map, marker);
        });
      }
  %script{async: "", defer: "defer", src: "https://maps.googleapis.com/maps/api/js?key=#{Rails.application.credentials.map_api_key}&callback=initMap"}
  